{{- if and .Values.ceemsAPIServer.enabled .Values.ceemsAPIServer.grafana.dashboards.create }}
{{- $ceemsAPIDSName := include "kube-ceems.api-server.fullname" . -}}
{{- $ceemsPromDSName := $.Values.kubePrometheusStackGrafana.sidecar.datasources.name -}}
{{- $ceemsPyroDSName := include "kube-ceems.pyroscope-ds-name" . -}}
{{- $clusterids := list -}}
{{- $clusterid := (include "kube-ceems.cluster-id" .) -}}
{{- range $key, $value := .Values.ceemsAPIServer.clusters }}
{{- $clusterids = append $clusterids $value.id -}}
{{- range $path, $_ :=  $.Files.Glob (printf "files/dashboards/%s/**.json" $value.manager) }}
{{- if and $.Values.ceemsLB.enabled (hasKey $.Values.ceemsLB.config "backends") }}
{{- range $_, $backend := $.Values.ceemsLB.config.backends }}
{{- if and (eq $backend.id $value.id) (hasKey $backend "tsdb") }}
{{- $ceemsPromDSName = printf "%s-%s-tsdb" (include "kube-ceems.lb.fullname" $) $value.id -}}
{{- end }}
{{- if and (eq $backend.id $value.id) (hasKey $backend "pyroscope") }}
{{- $ceemsPyroDSName = printf "%s-%s-pyroscope" (include "kube-ceems.lb.fullname" $) $value.id -}}
{{- end }}
{{- end }}
{{- end }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "kube-ceems.api-server.fullname" $ }}-{{ $value.id }}-{{ $path | base | replace "." "-" }}-dashboard
  namespace: {{ include "kube-ceems.api-server.namespace" $ }}
  labels:
    {{ tpl $.Values.kubePrometheusStackGrafana.sidecar.dashboards.label $ }}: {{ tpl $.Values.kubePrometheusStackGrafana.sidecar.dashboards.labelValue $ }}
    {{- include "kube-ceems.api-server.labels" $ | nindent 4 }}
  annotations:
    {{ $.Values.kubePrometheusStackGrafana.sidecar.dashboards.folderAnnotation }}: CEEMS-ClusterID-{{ $value.id }}-Manager-{{ $value.manager }}
data:
  {{ $path | base }}: |-
    {{ $.Files.Get $path | replace "${VAR_ORG_ID}" "1" | replace "${DS_PROMETHEUS}" $ceemsPromDSName | replace "${DS_CEEMS-API}" $ceemsAPIDSName | replace "${DS_GRAFANA-PYROSCOPE-DATASOURCE}" $ceemsPyroDSName | replace "${VAR_CLUSTER_ID}" $value.id | replace "${VAR_ENDPOINT}" "" | nindent 4 }}
{{- end }}
{{- end }}
{{- if and .Values.monitorCurrentCluster (not (has $clusterid $clusterids)) }}
{{- range $path, $_ :=  $.Files.Glob "files/dashboards/k8s/**.json" }}
{{- if $.Values.ceemsLB.enabled }}
{{- $ceemsPromDSName = printf "%s-%s-tsdb" (include "kube-ceems.lb.fullname" $) $clusterid }}
{{- $ceemsPyroDSName = printf "%s-%s-pyroscope" (include "kube-ceems.lb.fullname" $) $clusterid }}
{{- end }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "kube-ceems.api-server.fullname" $ }}-{{ $clusterid }}-{{ $path | base | replace "." "-" }}-dashboard
  namespace: {{ include "kube-ceems.api-server.namespace" $ }}
  labels:
    {{ tpl $.Values.kubePrometheusStackGrafana.sidecar.dashboards.label $ }}: {{ tpl $.Values.kubePrometheusStackGrafana.sidecar.dashboards.labelValue $ }}
    {{- include "kube-ceems.api-server.labels" $ | nindent 4 }}
  annotations:
    {{ $.Values.kubePrometheusStackGrafana.sidecar.dashboards.folderAnnotation }}: CEEMS-ClusterID-{{ $clusterid }}-Manager-k8s
data:
  {{ $path | base }}: |-
    {{ $.Files.Get $path | replace "${VAR_ORG_ID}" "1" | replace "${DS_PROMETHEUS}" $ceemsPromDSName | replace "${DS_CEEMS-API}" $ceemsAPIDSName | replace "${DS_GRAFANA-PYROSCOPE-DATASOURCE}" $ceemsPyroDSName | replace "${VAR_CLUSTER_ID}" $clusterid | replace "${VAR_ENDPOINT}" "" | nindent 4 }}
{{- end }}
{{- end }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "kube-ceems.api-server.fullname" . }}-admin-dashboard
  namespace: {{ include "kube-ceems.api-server.namespace" . }}
  labels:
    {{ tpl $.Values.kubePrometheusStackGrafana.sidecar.dashboards.label $ }}: {{ tpl $.Values.kubePrometheusStackGrafana.sidecar.dashboards.labelValue $ }}
    {{- include "kube-ceems.api-server.labels" . | nindent 4 }}
  annotations:
    {{ $.Values.kubePrometheusStackGrafana.sidecar.dashboards.folderAnnotation }}: CEEMS-Admin
data:
  cluster-status.json: |-
    {{ $.Files.Get "files/dashboards/admin/cluster-status.json" | replace "${DS_PROMETHEUS}" .Values.kubePrometheusStackGrafana.sidecar.datasources.name | nindent 4 }}
{{- end }}
